db.system.js.save(
 {
     _id: "traerRangosCochera",
     value : function(idUsuario, fecha, idCochera) 
             { 
				var v_idusuario;				var v_fecha;				var v_items;				var v_item;				var v_id;				var v__id;				var v_garage;				var allreservasArray1;				var allreservasArray2;				var v_fecha_actual = new Date();				v_time = Number(v_fecha_actual.toString().substring(v_fecha_actual.toString().search(":")-2, v_fecha_actual.toString().search(":")));				var v_fecha_s = v_fecha_actual.toJSON().substring(8,10) + "/" + v_fecha_actual.toJSON().substring(5,7) + "/" + v_fecha_actual.toJSON().substring(0,4);				v_idusuario = idUsuario;				v_fecha = fecha;				v_idcochera = idCochera;				//Borra de la colección temporaria la consulta anterior del usuario				db.tmpCochera.remove({ "idUsuario" : v_idusuario });				var allwork = db.workingHours.find().toArray();				if (v_fecha == v_fecha_s){					if (v_time <= allwork[0].from){						v_hora_check = allwork[0].from;					} else {						if (v_time < allwork[0].to){							v_hora_check = v_time;						} else {							v_hora_check = allwork[0].to;						}					}				} else {					v_hora_check = allwork[0].from;				}				//printjson(v_fecha);				//printjson("Entra");				//Recorre todos los rangos				while(v_hora_check < allwork[0].to) {				//printjson(v_garage);					if (v_hora_check < 10) {						v_hora_completa = "0" + v_hora_check.toString() + ":00:00";						v_hora_desde = "0" + v_hora_check.toString();					} else {						v_hora_completa = v_hora_check.toString() + ":00:00";						v_hora_desde = v_hora_check.toString();					}					v_hora_h = v_hora_check + 1;					if (v_hora_h < 10) {						v_hora_hasta = "0" + v_hora_h.toString();					} else {						v_hora_hasta = v_hora_h.toString();					}					var allreservasArray1 = db.reservations.find({							$and: [							{ "idCochera" : v_idcochera },							{ "fecha" : v_fecha },							{ "hora" : v_hora_completa }							]							}).toArray();					//Si encontro reservas u ocupaciones verifica que tipo de acciones puede tomar					 if (allreservasArray1.length > 0) {						var allusuario = db.users.find({ "id" : allreservasArray1[0].idUsuario }).toArray();						if (allreservasArray1[0].estado == "Ocupado") {							v_estado = "O";						} else {							v_estado = "R";						}						if (v_idusuario != allreservasArray1[0].idUsuario){							db.tmpCochera.insert( {"_id" : allreservasArray1[0]._id, "idUsuario" : v_idusuario, "rango" : v_hora_desde + "-" + v_hora_hasta, "name" : allusuario[0].name , "estado" : v_estado, "phone" : allusuario[0].phone, "accion" : { ocupar : "0", liberar : "0", reservar : "0", telefono : "1" }});						}						if ((v_idusuario == allreservasArray1[0].idUsuario) && (v_estado == "R")) {							if ((v_time >= v_hora_check) && (v_time <= v_hora_h)) {								db.tmpCochera.insert( {"_id" : allreservasArray1[0]._id, "idUsuario" : v_idusuario, "rango" : v_hora_desde + "-" + v_hora_hasta, "name" : allusuario[0].name , "estado" : v_estado, "phone" : allusuario[0].phone, "accion" : { ocupar : "1", liberar : "1", reservar : "0", telefono : "0" }});							} else {								db.tmpCochera.insert( {"_id" : allreservasArray1[0]._id, "idUsuario" : v_idusuario, "rango" : v_hora_desde + "-" + v_hora_hasta, "name" : allusuario[0].name , "estado" : v_estado, "phone" : allusuario[0].phone, "accion" : { ocupar : "0", liberar : "1", reservar : "0", telefono : "0" }});							}						} 						if ((v_idusuario == allreservasArray1[0].idUsuario) && (v_estado == "O")) {							if ((v_time >= v_hora_check) && (v_time <= v_hora_h)) {								db.tmpCochera.insert( {"_id" : allreservasArray1[0]._id, "idUsuario" : v_idusuario, "rango" : v_hora_desde + "-" + v_hora_hasta, "name" : allusuario[0].name , "estado" : v_estado, "phone" : allusuario[0].phone, "accion" : { ocupar : "0", liberar : "1", reservar : "1", telefono : "0" }});							} else {								db.tmpCochera.insert( {"_id" : allreservasArray1[0]._id, "idUsuario" : v_idusuario, "rango" : v_hora_desde + "-" + v_hora_hasta, "name" : allusuario[0].name , "estado" : v_estado, "phone" : allusuario[0].phone, "accion" : { ocupar : "0", liberar : "1", reservar : "0", telefono : "0" }});							}						}					 } else {						db.tmpCochera.insert( {"_id" : "0", "idUsuario" : v_idusuario, "rango" : v_hora_desde + "-" + v_hora_hasta, "name" : "Libre" , "estado" : "D", "phone" : "0", "accion" : { ocupar : "0", liberar : "0", reservar : "1", telefono : "0" }});					}					v_hora_check = v_hora_check + 1;				}				// Devuelve los rangos con su estado para la cochera				return db.tmpCochera.find({"idUsuario" : v_idusuario},{idUsuario : 0}).sort({ rango: 1 }).toArray();
             }
 });